<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="#5358e8" />
    <meta name="csrf-token" content="<%= csrfToken %>" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile Apado Chat</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link
      rel="stylesheet"
      href="vendor/icons/css/material-design-iconic-font.min.css"
    />
 
    <script
      src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"
      defer
    ></script>

    <style>
      @import url(http://fonts.googleapis.com/css?family=Noto+Sans);
      * {
        font-family: "Nunito", sans-serif;
        transition: all 0.3s ease-in-out;
      }

    </style>
    <script>
      var csrf_token = document
        .querySelector('meta[name="csrf-token"]')
        .getAttribute("content");
     
    </script>
  </head>

  <body
  x-data="{ editProfile:false } "
  style="background-image: url('https://source.unsplash.com/random'); background-size: cover;"
  >

  <div style="z-index: 200;" class="uerror hidden  shadow fixed top-14 right-12 py-2 px-5 text-white text-lg bg-red-500">
sdf
  </div>
  <div style="z-index: 200;" class="success hidden  shadow fixed top-14 right-12 py-2 px-5 text-white text-lg bg-green-500">safds</div>

  <div style="z-index: 200;" class="alert  hidden shadow fixed top-14 right-12 py-2 px-5 text-white text-lg bg-indigo-500">
sdf
  </div>

    <div
      class="
        preloader
        fixed
        top-0
        left-0
        bg-white
        flex
        items-center
        justify-center
        w-full
        h-full
      "
      style="z-index: 15555"
    >
      <div
        class="
          h-12
          w-12
          z-50
          rounded-full
          border-4 border-indigo-500
          bg-white
          m-5
          animate-spin
        "
        style="border-top-color: rgb(255, 255, 255)"
      ></div>
    </div>

    <!-- {{!-- nav bar first static --}} -->
    <%- include('partials/nav', {u:data}); %> 
    <div
      class="2xl:container mx-auto px-3 "
      
    >

    <div style="background: rgba(255,255,255,0.5); overflow: auto;" x-show="editProfile" class="fixed top-0 left-0 w-full h-full  z-50 grid items-center p-1 md:p-5  " >
       <div class="w-full md:w-1/2 p-3 bg-white mx-auto rounded shadow relative">
        <img class="preview absolute right-0 top-0 h-32 w-32 rounded-full border-4 border-white -mt-16 mr-4" src="<%= data.picture %>" alt="">
        <form enctype="multipart/form-data" id="editProfile">
            <style>
                .error{
                    color:red;
                }
            </style>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <h3 class="font-bold text-xl mb-7">Update your Profile </h3>
            <div class="mt-3">
                <label for="name">Full Name</label> <br>
                <input type="text" value="<%=  data.name %>" name="name" id="name" required  class="px-3 w-full py-3 rounded border border-gray-200">
            </div>
            <div class="mt-3">
                <label for="about">About</label> <br>
                <textarea name="about" id="about" required class="px-3 w-full py-3 rounded border border-gray-200 " style="min-height: 150px;"> <%= data.about %> </textarea>
            </div>
            <div class="mt-3">
                <label for="picture">Profile Picture</label> <br>
               <input id="file-upload" accept="image/jpeg,image/jpg,image/png" type="file" name="picture" id="picture" class="w-full">
            </div>
            <div class="mt-6 flex items-center justify-between">
                <button  class="flex-1 ubtn rounded-full bg-blue-400 text-white antialiased font-bold hover:bg-blue-dark px-4 py-2 mr-2">Update</button>
                <button type="button" class="flex-1 rounded-full border-2 border-grey font-semibold text-black px-4 py-2" @click="editProfile = false">Cancel</button>
            </div>
            </div>
        </form>
    </div>
    </div>

      <div class="">
        <div class="font-sans leading-tight min-h-screen bg-grey-lighter p-8">
            <div class="max-w-md mx-auto bg-white rounded-lg overflow-hidden ">
              <div class="bg-cover h-40" style="background-image: url('/images/cover.jpg');"></div>
              <div class="border-b px-4 pb-6">
                  <div class="text-center sm:text-left sm:flex mb-4">
                      <img class="h-32 w-32 rounded-full border-4 border-white -mt-16 mr-4" src="<%= data.picture %>" alt="">
                      <div class="py-2">
                          <h3 class="font-bold text-2xl mb-1 capitalize "><%= data.name %></h3>
                          <div class="inline-flex text-grey-dark sm:flex items-center">
                            <i class="zmdi zmdi-email" style="color: #999; font-size: 22px; margin-right: 10px; display:inline-block;"></i>
                             <%= data.email %>
                          </div>
                      </div>
                  </div>
                  <h3 class="font-bold text-lg"> About </h3>
                  <div class="text-gray-400"> 
                      <%= data.about == null ? 'Lorem ipsum dolor sit amet consectetur adipisicing elit. Veritatis at laborum, dignissimos repellendus ex beatae, pariatur hic incidunt numquam officia debitis assumenda eius vitae tempore.' : data.about %>
                  </div>
                 
                  <div class="mt-4">
                      <div>
                          <button @click="editProfile = true" class="px-4 py-3 border-2 leading-3 border-gray-400 font-semibold text-lg text-gray-400 rounded-full w-full block hover:bg-indigo-500 hover:text-white hover:border-white">Edit</button>
                      </div>
                  </div>
              </div>
             
            </div>
          </div>
      </div>
    </div>
    

    <script src="js/jquery.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script src="/vendor/jquery-validation-1.19.3/dist/jquery.validate.min.js"></script>
<script>
 $(document).ready(function () {
        //hide pre loaders.
        setTimeout(() => {
          $(".preloader").hide();
        }, 1200);
    })

    $("#file-upload").on('change', function(){
        var file = document.getElementById('file-upload').files[0];
        if(file && file.size < 2097152){
          var reader = new FileReader();

        reader.onload = function(){
        
          $(".preview").attr('src', this.result);
         
          
        }
        reader.readAsDataURL(file);
        }else{
          alert('file not choosen or image size is greater then 2 MB. choose smaller files or valid file type.');
          $(".preview").attr('src', null);
        
        }
      });

      
      $("#editProfile").validate({
        rules: {
          name: {
            required: true,
            minlength:5,
          },
          about: {
            required: true,
            minlength: 10,
          },
        },
        messages: {
          name: {
            required: "please enter name.",
            minlength: "enter a valid name or name too short.",
          },
          about: {
            required: "about is required.",
            minlength: "about must be greater then 10 chars.",
          },
        },
        submitHandler: function (form, event) {
          event.preventDefault();
          
          let data = new FormData(document.getElementById('editProfile'));
          $.ajax({
            url: "/updateprofile",
            headers: { Accept: "application/json", "CSRF-Token": csrf_token },
            method: "POST",
            contentType: false,
            processData: false,
            data: data,
            beforeSend: function () {
             $(".alert").removeClass('hidden').text('Updating...')
             $(".ubtn").text("Updating...").attr("disabled", true);
            },
            success: function (res) {
                $(".alert").addClass('hidden').text('...')
              $(".ubtn").text("Update").attr("disabled", false);
              if (res.success == true) {
                $(".success").removeClass('hidden').text('Update Success.')
                window.location.reload()
              } else {
                $(".uerror").removeClass("hidden").text(res.message);
              }
            },
            error: function (err) {
                $(".alert").addClass('hidden').text('...')
              $(".ubtn").text("Update").attr("disabled", false);
              $(".uerror").removeClass("hidden").text(err.responseJSON?.message);
              
            },
          });
        },
      });
</script>
  </body>
</html>
